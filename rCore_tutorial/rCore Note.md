# rCore Note

## Chapter0 操作系统概述

### 什么是操作系统

OS两个功能：

- 向下管理并控制计算机硬件和各种外设
- 向上管理应用软件并提供各种服务

<img src="https://xmtxpic.oss-cn-hangzhou.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-17%2016.41.33.png" alt="截屏2022-10-17 16.41.33" style="zoom:50%;" />

执行环境(Execution Environment)：

- 硬件
- 操作系统内核
- 运行时库
- 图形界面支持库等

<img src="https://xmtxpic.oss-cn-hangzhou.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-17%2016.45.52.png" alt="截屏2022-10-17 16.45.52" style="zoom:50%;" />

### OS的系统调用接口

**API与ABI**

**系统调用接口与功能**

- 一个运行的程序如何能输出字符信息？如何能获得输入字符信息？
- 一个运行的程序可以要求更多（或更少）的内存空间吗？
- 一个运行的程序如何持久地存储用户数据？
- 一个运行的程序如何与连接到计算机的设备通信并通过它们与物理世界通信？
- 多个运行的程序如何同步互斥地对共享资源进行访问？
- 一个运行的程序可以创建另一个程序的实例吗？需要等待另外一个程序执行完成吗？一个运行的程序能暂停或恢复另一个正在运行的程序吗？

操作系统主要通过**基于ABI 的系统调用接口**来给应用程序提供上述服务，以支持应用程序的各种需求

- 进程（即程序运行过程）管理：复制创建进程 fork 、退出进程 exit 、执行进程 exec 等
- 线程管理：线程（即程序的一个执行流）的创建、执行、调度切换等
- 线程同步互斥的并发控制：互斥锁 mutex 、信号量 semaphore 、管程 monitor 、条件变量 condition variable 等
- 进程间通信：管道 pipe 、信号 signal 、事件 event 等
- 虚存管理：内存空间映射 mmap 、改变数据段地址空间大小 sbrk 、共享内存 shm 等
- 文件 I/O 操作：对存储设备中的文件进行读 read 、写 write 、打开 open 、关闭 close 等操作
- 外设 I/O 操作：外设包括键盘、显示器、串口、磁盘、时钟 … ，主要采用文件 I/O 操作接口

<img src="https://xmtxpic.oss-cn-hangzhou.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-17%2016.55.03.png" alt="截屏2022-10-17 16.55.03" style="zoom:50%;" />

### 操作系统抽象

**执行环境**

<img src="https://xmtxpic.oss-cn-hangzhou.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-17%2017.01.20.png" alt="截屏2022-10-17 17.01.20" style="zoom:50%;" />

对于应用程序的执行环境而言，应用程序只能看到执行环境直接提供给它的接口（API 或 ABI），这使得应用程序所能得到的服务取决于执行环境提供给它的访问接口

`定义`

**执行环境**是应用程序正确运行所需的服务与管理环境，用来完成应用程序在运行时的数据与资源管理、应用程序的生存期等方面的处理，它定义了应用程序有权访问的其他数据或资源，并决定了应用程序的行为限制范围

**普通控制流(CCF)**

应用程序仅能接触到其当前所在的执行环境下，不会跳到其他环境

**异常控制流(ECF)**

一种控制流的“突变”，即控制流脱离了其所在的执行环境，并产生执行环境的切换

应用程序 *感知* 不到这种异常的控制流情况，这主要是由于操作系统把这种情况 *透明* 地进行了执行环境的切换和对各种异常情况的处理，让应用程序从始至终地 *认为* 没有这些异常控制流的产生

**控制流上下文(Context)**

控制流在执行完某指令时的物理资源内容，即确保下一时刻能继续 *正确* 执行控制流指令的物理资源内容称为控制流的**上下文** (Context) ，也可称为控制流所在执行环境的状态

- 物理资源：即计算机硬件资源，如CPU的寄存器、可访问的物理内存等
- 虚拟资源：即操作系统提供的资源，如文件，网络端口号，网络地址，信号等

上下文处理：

- 异常控制流的上下文： CPU 和操作系统协同完成
- 函数转移控制流的上下文保存与恢复：编译器

三类异常控制流

- 外设中断 (Device Interrupt) 

  异步产生，与处理器执行无关

  <img src="https://xmtxpic.oss-cn-hangzhou.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-17%2017.20.14.png" alt="截屏2022-10-17 17.20.14" style="zoom:50%;" />

- 陷入 (Trap) 

  要通过syscall请求操作系统服务而**有意引发**的事件

- 异常 (Exception，也称Fault Interrupt)

  在处理器执行指令期间检测到**不正常的或非法的内部事件**

  <img src="https://xmtxpic.oss-cn-hangzhou.aliyuncs.com/img/%E6%88%AA%E5%B1%8F2022-10-17%2017.21.59.png" alt="截屏2022-10-17 17.21.59" style="zoom:50%;" />

**进程(Process)**

程序的“幻觉”：它是整个计算机系统中当前运行的唯一的程序，能够独占使用处理器、内存和外设，而且程序中的代码和数据是系统内存中唯一的对象